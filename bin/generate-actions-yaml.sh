#!/usr/bin/env bash
set -euo pipefail

CI_TEMPLATE="bin/ci-template.yaml"
CI_FILE=".github/workflows/ci.yaml"

function copyTemplate() {
  rm -rf $CI_FILE
  echo -e "# File generated by bin/generate-actions-yaml.sh\n$(cat $CI_TEMPLATE)" > $CI_FILE
}

function appendAction() {
  image=$1
  tag=$2
  {
    echo "      -"
    echo "        name: Build and push - $image:$tag"
    echo "        uses: docker/build-push-action@v2"
    echo "        with:"
    echo "          file: ./images/$image/Dockerfile.$tag"
    echo "          tags: \${{ secrets.DOCKERHUB_USERNAME }}/enterprise-$image:$tag"
    echo "          push: \${{ github.event_name != 'pull_request' }}"
  } >> $CI_FILE
}

function main() {
  # Move to top level
  pushd $(git rev-parse --show-toplevel)

  # Create template yaml
  copyTemplate

  # Add an action per Dockerfile
  image_dirs=$(ls images)
  for image in ${image_dirs[@]}; do
    dockerfiles=$(ls images/$image/Dockerfile*)
    for dockerfile in ${dockerfiles}; do
      tag=${dockerfile##*.}
      appendAction "$image" "$tag"
    done
  done

  # Pop back to original dir
  popd

  echo "Updated $CI_FILE"
}

main
